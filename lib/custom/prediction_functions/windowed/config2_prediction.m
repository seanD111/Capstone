function [Y,Xf,Af] = myNeuralNetworkFunction(X,~,~)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 21-Apr-2016 16:42:57.
%
% [Y] = myNeuralNetworkFunction(X,~,~) takes these arguments:
%
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 44xQ matrix, input #1 at timestep ts.
%
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 6xQ matrix, output #1 at timestep ts.
%
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0;0;0;0;-194.809818048627;-26.7331329931473;-38.4624542228069;-62.1181202841069;-31.8252599829903;-37.9132017832298;-46.3509916055386;-42.1836754160256;-35.4586450719403;-37.295298847616;-42.1420722203339;-43.4989471205404;-35.9094328098201;-610.228965320263;-579.385968887725;-588.707338688689;-325.827343157046;-329.700161266106;-475.943448772201;-386.729512174624;-367.661007684664;-519.097741931371;-475.628401896874;-433.696161568048;-397.707351154529;-608.04515600357;-1989.63839815725;-993.420310201439;-696.966234359947;-436.960175316527;-608.219719170257;-551.706533737909;-474.298357093321;-515.635906639629;-587.339685404384;-464.117350653849;-464.660277213478;-469.233493924714;-638.734714157982;-434.854895227609];
x1_step1.gain = [0.00012808725664915;0.000127988292622736;0.000127928994348745;0.000127320416659333;0.00024405691460894;0.0131500364040467;0.0191297466032947;0.0209880573812125;0.0272349546504405;0.0245749366117307;0.0227444174790294;0.0243976523484374;0.0263766901559837;0.0252761756036493;0.0231371248219328;0.0244872768665979;0.0209857469245224;0.000635534281081666;0.00139572530498129;0.00217613314683213;0.00249452953941457;0.00281766225194279;0.00220065779935499;0.0025788219605096;0.00232304612078159;0.00211588836737191;0.00183242157031678;0.0023072514992385;0.0019970215397754;0.00185111685827001;0.000505522579647338;0.0010870973852794;0.0016612759472648;0.00199475518182476;0.00201868187885367;0.0021055462774131;0.00201986290494078;0.00207880523434537;0.00170255102738918;0.00184979628531586;0.00214579239020611;0.0021366613732587;0.00172375085802864;0.00237669061405805];
x1_step1.ymin = -1;

% Layer 1
b1 = [-8.6032508767512113;-1.5443872297783079;-1.7931651683314023;-0.20456182372564738;-0.99458040792051527;-4.1792231223610052;2.6265160939830445;1.7327868967457682;-0.45193620097278125;4.5028112067427735];
IW1_1 = [0.60688550201474134 0.21142431975650502 0.15737714144050194 0.21423836185843972 -3.2588284256470725 -6.5881454954810961 -0.13946279112189766 -4.4291962005973859 -0.64803046279273924 -0.41119413985945724 -0.92340905667212914 -0.082166792926177651 0.433783589122963 0.19981702622155878 1.0807929630583366 -0.73542769405730979 0.64724050739159 -0.70099979848059091 -1.3208515834574825 0.80418877808420719 -0.052064157737778588 0.099094241716310691 -0.13291604837400575 0.031132818028289374 0.10164869160057978 -0.019881604047351748 0.10979567283020146 0.013198908278636639 0.093458928443908698 0.014191610681101311 3.0110343400906379 0.82439074462941309 -0.37080148557313097 -2.0324593376698439 -0.47223604879493103 -0.16586441471759789 -0.50786142336537499 -0.24723357977203245 0.56711761576228259 0.083901812933001058 0.6749236815830828 -0.41725103881332498 0.2730607025122514 -0.21021179177562299;-0.42792088464145189 -2.6966692559545922 10.66643587667671 1.2192251544517019 1.2642925874363249 0.83742234821038242 0.51758985987089612 0.92117378483887968 0.88282787598261814 0.80010236504577048 1.0279421236262709 -0.095798262847783852 0.24800899518659311 0.69187170165422651 -0.38930705304407764 0.51958831833700703 -0.024622966280684215 -0.011570452294479295 0.64046148240534417 -0.17423310889155852 -0.059466798801386354 0.20341121468402359 -0.28582790735490543 -0.10655627026898978 -0.021070243211591701 0.064315585135797118 0.13626827165212671 -0.079681945704299387 0.0088435408486411248 -0.10761673319429142 -0.52603789615373564 1.957514378567794 -0.49703825774117905 1.2191451599575536 0.36255780877742494 0.63837143185157497 0.72750573752260816 -0.074290221655820998 0.19772402825981794 0.53990832555875679 -0.10307711845526271 0.20849026026195655 -0.15284926011007025 -0.20255670595918779;0.69751586686361733 -0.50985086380439204 5.5945047569205091 1.4885183510074613 2.1388702095473957 -2.4303069679626033 0.51469652820878486 0.0083764634997302301 0.30369579495975479 -0.54075345804206087 -0.065117714372655261 -0.058936605000686107 -0.12649926211256393 -0.47280327450623344 -0.57407664527894164 -0.31102061063945019 -0.17098668475551346 -0.8901759595135873 0.51557197585952097 -0.012888182041454845 -0.010780661363207792 -0.10312113163610377 -0.10871079695419501 -0.15667214402288376 0.0049470920511437821 -0.034737719906607609 -0.048963011598014416 -0.079965509678818422 -0.023504829194038613 0.0021043399732323118 -2.3019662260318672 -0.78132981894948073 -0.13227635671198976 0.35675232887370101 0.24298710383596131 -0.11425568705197688 -0.029427973832598035 0.013619700624102483 -0.14484187627763692 -0.23793381332135127 -0.26935473176466029 -0.12868299405060857 -0.20514506861051318 -0.38427152999359721;-0.77467300328058242 -0.3816107659646833 0.29325167518303363 -0.33231843473260431 0.0048675610156160886 -0.040966575826294954 -0.24191002683364335 0.33444619189007174 0.94183055640765745 -0.33305234626565938 0.089617432597607613 -0.001381721197401329 -0.80068714765564142 -0.32507899540567509 -0.31824766514626646 0.23658468687490031 0.086189953240124531 0.37157306593834172 -0.10072983625120756 0.02797097554987487 -0.020071467192562101 0.097753404212377396 -0.080910597987663563 0.044706584690784687 -0.048992323335013743 0.054786963112768837 -0.023153194468377696 0.010959144433927303 -0.024848997215953076 -0.051606762795500298 0.87607873414579041 0.3215817597731937 -0.13400320790339815 0.29880037057790315 0.64702917789298164 -0.31183315449451898 0.070640323674042299 -0.052709227417859474 -0.6101546266745147 -0.23233085067392709 -0.16158785696376909 0.075333116735094866 0.077819869099574765 -0.032899086922155082;10.047617238420965 2.070893693606096 -0.21025664145511944 -0.77241356901015545 2.3900832984269291 5.088712425934359 1.7523147120085205 -1.2757134054596577 1.088006625510884 -1.9696784015441429 0.32296337180839629 -0.62752024549850061 -0.12544113069303181 0.42021659327366329 -1.7938141110775847 0.9991613296687466 -1.0857355224101171 0.11708143844751866 0.18763388843250106 0.24354276111987669 0.19510393141687232 0.088823918025273146 0.013828742773236863 0.031607119914193238 0.2468076815354808 0.2148233597018582 -0.040901651159856181 0.048400952432015594 0.40207799658582993 -0.15554488775390896 -0.61418816320637548 1.4975133536045193 0.92525462288319293 -0.54913669882515359 0.74863287967369552 -0.93511031923000931 0.29130722215022192 -0.31374971359256293 -0.094331045754277254 0.30124873654539308 -1.1912022010048675 0.78973729864896025 -0.54997911403227018 0.15983844508785136;0.068869061802860843 -0.027361426683951855 0.26505146098047355 0.093347416670390732 -7.286593783981572 3.9420015915607642 0.9069927830372787 0.61070469800024385 -0.48640463509126919 0.49790042072308016 0.7610259431935319 0.82035506236403288 0.78107092520344978 0.33096709741760288 0.8229709952121278 0.10618618083752451 0.57542944935203477 0.24147201866336274 0.45538184544653176 -0.11140725292045356 0.047182554533381958 -0.017609560872850205 0.030073574093915725 0.016249426329981203 0.019465315520908001 0.02609684965275938 0.071026712572181988 -0.0054556859139623754 0.025139819766562637 0.0072538242694844806 -0.64314772186557156 1.4968332938967133 0.68315086547299619 0.21286177134395601 -0.34437439303456913 0.27118651725354687 0.4619135416145404 0.51163909074586689 0.58048426803005371 0.2205693483953324 0.45721234121740695 0.072271777101512627 0.34305673758936017 -0.27403260694828413;2.5743262339266964 0.9218690279527898 7.7910393115259797 2.7355947856700675 0.94384660760978722 -0.13695178628555724 -0.72674356526157713 -0.29737138742810754 -1.3437850515623451 -0.83127212394151306 -0.12570771570155728 0.47177353693071472 0.13089305072514218 -0.20917288896277064 0.050553531288870066 0.25115921071228842 0.098547623307412471 -0.26082972625423761 0.59411764269782674 -0.051013578347522882 0.16782320884183891 -0.14156020032613975 0.043846666951241273 0.012719854727747542 0.067447050936830968 -0.15571668294575639 0.15693939436146365 -0.23678996635185834 0.040890917364075061 -0.10457766835325728 -4.1286456349020071 -0.65243732021838785 -0.44338511015470217 -0.20769553810943556 -1.0545479487759102 -0.37307136056335016 0.052590091393509376 0.25588357768079029 0.08545924539587213 -0.11482574454922148 -0.052228948722340997 0.26194125047205524 0.010125134083341498 0.12828655264307492;3.5098257851177426 -2.7588209393316796 -1.7578162081896636 -0.61403554202146382 0.21166951959520774 0.097296060245628826 1.7724830701110592 2.0030997794784917 1.0846851844509757 -0.039281641066581767 0.56309692801484856 -0.088517010428870474 1.0147507840441008 0.58235106722480745 -0.13866927272088664 0.44667796798274545 -0.39279971020240084 -0.088890565118441775 -0.23473552028605638 -0.12374444094556841 -0.15621990980762659 0.014536776359521998 -0.16515309993668778 -0.032336345265166405 -0.024407531279203511 -0.088386824109880108 0.19450243555052607 -0.016698981814959348 -0.016830468922024628 0.11149060654705913 1.5314881677269985 0.35841467145824996 0.34135123355301827 1.2390150509981765 0.60147595147645738 0.20531607273500033 0.28160522349767375 -0.12627495442110245 0.84494284910913908 0.37710671692217212 -0.10183373168361451 0.34639090802250866 -0.24822151329164313 0.028857403054688657;3.1303704707173297 0.40305665223019793 3.8757393540092222 1.9585318169239276 -4.1942375987801865 -0.29421448956732249 -2.7968716975306385 1.5890351632466877 0.41890381842623942 0.59631901717071434 -0.49379523315420071 0.42855269880360991 0.34933183519165989 0.21051848360467038 -0.88586173038239535 -0.24630345435789031 0.44428693043361656 -0.22153769469776854 0.5301447075180864 0.065395352478625171 0.062377524082108268 0.14139690698530263 -0.15549214454543575 0.027299038640445184 0.070455218344525103 -0.070575770549338571 0.15384378436690421 -0.07717345009404572 0.24137701077384918 -0.094146129933524281 -0.51868978038114688 -2.3540811821811563 -0.68315367572220131 0.97028724694290724 0.51248728437958468 0.39759032819902146 0.024503109198139118 0.24261790673382974 0.34153385323120927 0.11734557164982441 -0.54465854353351606 -0.099006486279169734 0.27396000126981052 0.11281299539097325;1.5935153094085655 -8.3287935316066033 -0.95540457374558097 -2.0867535768864069 -2.4073305614526195 0.9646168096099631 -1.1068810962693805 -0.86907578783077921 0.11316380776802923 0.4942814132950003 -0.39961471784528146 0.36775375882059652 0.064628621010628093 0.88060372335073611 0.73633026795895418 -0.13836201370054102 -0.29265739698838694 2.7835263473064362 0.83646321156951975 0.07195049950139043 0.42292409544430548 0.635647734469724 0.41609835103791054 -0.1235690901378774 0.12830402561530618 -0.0026901349151027612 0.56032709119315094 -0.2900772717431328 0.32026876561918294 0.35439426843994054 1.9742499245285738 -1.1336644328048144 -0.4835954129741542 -0.51137730763220968 0.11125813613592397 0.2457286806506134 -0.091772840129401678 0.10806034959002227 0.024504061478549562 0.57020567301485714 0.11734415039423322 -0.021071472152013118 -0.35312652317486359 0.23752554713196425];

% Layer 2
b2 = [-8.5649044151784643;-5.7513178205682083;-0.89864633733470134;15.971644324995561;-4.8059973083588687;2.714846387037221];
LW2_1 = [1.9606560313200465 -1.0245235289052395 3.9065099709522593 5.8693878031762141 -3.9187535253547452 8.1243296000566829 -9.1357871880879618 6.1417631282727854 0.61285043097710212 0.39972551863764583;1.0255681137504533 -0.5701402753970306 -2.4542101699704491 2.249859695788754 0.40381045958433859 -2.3009168982053549 1.9453113707138423 -1.5248651561339863 -0.31716838790582447 6.0117117724280371;0.11636985289422071 -0.24023501669926381 1.1601949672438172 -1.0031023326474147 -3.9502247975169418 -0.68204307569409339 -3.1680337254537201 -0.66552996974879108 3.979550530521462 -1.5532861136882361;5.1248245270115174 0.38805866656574434 1.0826828664462773 0.061400716182597667 4.3898099817714149 5.0140361347218541 2.3728859958670201 0.27205344252626951 -2.1391744901032572 -3.2956150648445317;-2.8418783241694894 3.3985533945117541 -6.0535011409312034 -7.2709572052224161 2.2707688565524631 -7.8332200360663453 5.3433495348195903 -3.6890875273403512 -2.6263365016534328 1.7933691912004435;-5.6759316537093234 -1.354482417174061 3.604155284527061 -0.51659432323589471 2.5969672692108312 -2.1109709445567066 0.95339913436111112 0.73841356583731743 0.87393468027557464 -3.7080896300389403];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},2); % samples/series
else
    Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS
    
    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = softmax_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Output 1
    Y{1,ts} = a2;
end

% Final Delay States
Xf = cell(1,0);
Af = cell(2,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Competitive Soft Transfer Function
function a = softmax_apply(n,~)
if isa(n,'gpuArray')
    a = iSoftmaxApplyGPU(n);
else
    a = iSoftmaxApplyCPU(n);
end
end
function a = iSoftmaxApplyCPU(n)
nmax = max(n,[],1);
n = bsxfun(@minus,n,nmax);
numerator = exp(n);
denominator = sum(numerator,1);
denominator(denominator == 0) = 1;
a = bsxfun(@rdivide,numerator,denominator);
end
function a = iSoftmaxApplyGPU(n)
nmax = max(n,[],1);
numerator = arrayfun(@iSoftmaxApplyGPUHelper1,n,nmax);
denominator = sum(numerator,1);
a = arrayfun(@iSoftmaxApplyGPUHelper2,numerator,denominator);
end
function numerator = iSoftmaxApplyGPUHelper1(n,nmax)
numerator = exp(n - nmax);
end
function a = iSoftmaxApplyGPUHelper2(numerator,denominator)
if (denominator == 0)
    a = numerator;
else
    a = numerator ./ denominator;
end
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end
